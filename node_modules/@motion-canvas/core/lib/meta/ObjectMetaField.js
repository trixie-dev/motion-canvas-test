import { ValueDispatcher } from '../events';
import { MetaField } from './MetaField';
class ObjectMetaFieldInternal extends MetaField {
    /**
     * Triggered when the nested fields change.
     *
     * @eventProperty
     */
    get onFieldsChanged() {
        return this.event.subscribable;
    }
    constructor(name, fields) {
        const map = new Map(Object.entries(fields));
        super(name, Object.fromEntries(Array.from(map, ([name, field]) => [name, field.get()])));
        this.type = Object;
        this.ignoreChange = false;
        this.customFields = {};
        this.handleChange = () => {
            if (this.ignoreChange)
                return;
            this.value.current = {
                ...this.transform('get'),
                ...this.customFields,
            };
        };
        this.event = new ValueDispatcher([...map.values()]);
        this.fields = map;
        for (const [key, field] of this.fields) {
            Object.defineProperty(this, key, { value: field });
            field.onChanged.subscribe(this.handleChange);
        }
    }
    set(value) {
        this.ignoreChange = true;
        for (const [key, fieldValue] of Object.entries(value)) {
            const field = this.fields.get(key);
            if (field) {
                field.set(fieldValue);
            }
            else {
                this.customFields[key] = fieldValue;
            }
        }
        this.ignoreChange = false;
        this.handleChange();
    }
    serialize() {
        return {
            ...this.transform('serialize'),
            ...this.customFields,
        };
    }
    clone() {
        const cloned = new this.constructor(this.name, this.transform('clone'));
        cloned.set(structuredClone(this.customFields));
        return cloned;
    }
    transform(fn) {
        const transformed = Object.fromEntries(Array.from(this.fields, ([name, field]) => [name, field[fn]()]));
        return transformed;
    }
}
/**
 * Represents an object with nested meta-fields.
 */
export const ObjectMetaField = ObjectMetaFieldInternal;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT2JqZWN0TWV0YUZpZWxkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL21ldGEvT2JqZWN0TWV0YUZpZWxkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFDMUMsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLGFBQWEsQ0FBQztBQW1CdEMsTUFBTSx1QkFFSixTQUFRLFNBQXFCO0lBRzdCOzs7O09BSUc7SUFDSCxJQUFXLGVBQWU7UUFDeEIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQztJQUNqQyxDQUFDO0lBT0QsWUFBbUIsSUFBWSxFQUFFLE1BQVM7UUFDeEMsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQzVDLEtBQUssQ0FDSCxJQUFJLEVBQ0osTUFBTSxDQUFDLFdBQVcsQ0FDaEIsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FDMUMsQ0FDaEIsQ0FBQztRQXZCWSxTQUFJLEdBQUcsTUFBTSxDQUFDO1FBV3BCLGlCQUFZLEdBQUcsS0FBSyxDQUFDO1FBQ3JCLGlCQUFZLEdBQTRCLEVBQUUsQ0FBQztRQW9EM0MsaUJBQVksR0FBRyxHQUFHLEVBQUU7WUFDNUIsSUFBSSxJQUFJLENBQUMsWUFBWTtnQkFBRSxPQUFPO1lBQzlCLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHO2dCQUNuQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDO2dCQUN4QixHQUFHLElBQUksQ0FBQyxZQUFZO2FBQ3JCLENBQUM7UUFDSixDQUFDLENBQUM7UUE3Q0EsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLGVBQWUsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNwRCxJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQztRQUNsQixLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUN0QyxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsRUFBQyxLQUFLLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQztZQUNqRCxLQUFLLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7U0FDOUM7SUFDSCxDQUFDO0lBRWUsR0FBRyxDQUFDLEtBQTBCO1FBQzVDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO1FBQ3pCLEtBQUssTUFBTSxDQUFDLEdBQUcsRUFBRSxVQUFVLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3JELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ25DLElBQUksS0FBSyxFQUFFO2dCQUNULEtBQUssQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7YUFDdkI7aUJBQU07Z0JBQ0wsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsR0FBRyxVQUFVLENBQUM7YUFDckM7U0FDRjtRQUNELElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDO1FBQzFCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUN0QixDQUFDO0lBRWUsU0FBUztRQUN2QixPQUFPO1lBQ0wsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQztZQUM5QixHQUFHLElBQUksQ0FBQyxZQUFZO1NBQ3JCLENBQUM7SUFDSixDQUFDO0lBRWUsS0FBSztRQUNuQixNQUFNLE1BQU0sR0FBRyxJQUFVLElBQUksQ0FBQyxXQUFZLENBQ3hDLElBQUksQ0FBQyxJQUFJLEVBQ1QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FDeEIsQ0FBQztRQUNGLE1BQU0sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO1FBRS9DLE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFVUyxTQUFTLENBQ2pCLEVBQVE7UUFFUixNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUNwQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUNuQyxDQUFDO1FBRS9CLE9BQU8sV0FBVyxDQUFDO0lBQ3JCLENBQUM7Q0FDRjtBQVFEOztHQUVHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sZUFBZSxHQUFHLHVCQUs5QixDQUFDIn0=